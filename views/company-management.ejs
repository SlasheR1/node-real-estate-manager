<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/tables.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/company.css">
</head>
<body>
    <%- include('partials/header') %>

    <main class="container company-management-container">

        <%- include('partials/messages') %>
        <div id="js-company-messages"></div>

        <%# Проверяем наличие ошибки или компании для отображения %>
        <% if (locals.error) { %>
            <div class="flash-message flash-error"><%= error %></div>
            <a href="/" class="btn btn-secondary">На главную</a>
        <% } else if (locals.company && company.companyId) { %>
            <div class="company-header">
                <div class="company-logo-container">
                     <% if (company.companyLogoData) { %>
                         <% let logoType = company.companyLogoData.startsWith('/9j/') ? 'image/jpeg' : 'image/png'; %>
                         <img src="data:<%= logoType %>;base64,<%= company.companyLogoData %>" alt="Логотип <%= company.companyName %>" class="company-logo">
                     <% } else { %>
                         <div class="company-logo-placeholder"><i class="fas fa-building"></i></div>
                     <% } %>
                </div>
                <div class="company-title-section">
                    <h1><%= company.companyName %></h1>
                    <p class="company-id">ID: <%= company.companyId %></p>
                </div>
                 <%# Кнопка редактирования только для Owner'а этой компании %>
                 <% if (currentUser && currentUser.role === 'Owner' && currentUser.companyId === company.companyId) { %>
                    <button type="button" class="btn btn-edit btn-small edit-company-btn" onclick="toggleEditMode(true)">Редактировать</button>
                 <% } %>
            </div>

            <hr class="company-divider">

            <!-- Секция Баланса -->
            <section class="company-section company-balance-section">
                <h2><i class="fas fa-wallet"></i> Баланс Компании</h2>
                <p class="balance-value"><%= new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(company.Balance || 0) %></p>
                <%# Исправленная и раскомментированная ссылка %>
                <div style="text-align: center; margin-top: 15px;">
                   <a href="/company/balance-history?id=<%= company.companyId %>" class="btn btn-secondary btn-small">История баланса</a>
                </div>
           </section>

             <!-- Форма Редактирования Компании -->
             <% if (currentUser && currentUser.role === 'Owner' && currentUser.companyId === company.companyId) { %>
                <section id="editCompanySection" class="company-section company-edit-section hidden">
                    <h2><i class="fas fa-pencil-alt"></i> Редактировать данные компании</h2>
                    <form id="companyEditForm" action="/company/edit" method="POST" enctype="multipart/form-data">
                        <div class="form-grid company-edit-grid">
                            <div class="form-group form-group-full"> <label for="editCompanyName">Название компании *</label> <input type="text" id="editCompanyName" name="companyName" value="<%= company.companyName %>" required> </div>
                            <div class="form-group"> <label for="editCompanyContactEmail">Контактный Email</label> <input type="email" id="editCompanyContactEmail" name="companyContactEmail" value="<%= company.companyContactEmail || '' %>"> </div>
                            <div class="form-group"> <label for="editCompanyContactPhone">Контактный Телефон</label> <input type="tel" id="editCompanyContactPhone" name="companyContactPhone" value="<%= company.companyContactPhone || '' %>"> </div>
                            <div class="form-group form-group-full"> <label for="editCompanyWebsite">Веб-сайт</label> <input type="url" id="editCompanyWebsite" name="companyWebsite" value="<%= company.companyWebsite || '' %>" placeholder="https://..."> </div>
                            <div class="form-group form-group-full logo-upload-section">
                                <label for="editCompanyLogo">Новый Логотип (макс. 1MB)</label>
                                <input type="file" id="editCompanyLogo" name="companyLogo" accept="image/*">
                                <% if (company.companyLogoData) { %>
                                    <div class="checkbox-group" style="margin-top: 5px;"> <input type="checkbox" id="removeLogo" name="removeLogo" value="1"> <label for="removeLogo" style="font-weight: normal;">Удалить текущий логотип</label> </div>
                                <% } %>
                                <div class="logo-preview-container" style="margin-top: 10px;"> <label style="font-size:0.9em;">Предпросмотр нового:</label> <img id="editLogoPreview" src="#" alt="Предпросмотр нового логотипа" class="company-logo-preview"> </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary"> <span class="button-text">Сохранить</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button>
                            <button type="button" class="btn btn-secondary" onclick="toggleEditMode(false)">Отмена</button>
                        </div>
                    </form>
                </section>
             <% } %>

            <!-- Секция Управления Персоналом -->
            <section class="company-section company-staff-section">
                <h2><i class="fas fa-users-cog"></i> Персонал Компании</h2>
                <% if (locals.staffList && staffList.length > 0) { %>
                    <div class="table-responsive">
                        <table class="data-table staff-table">
                            <thead> <tr> <th>Логин</th> <th>ФИО</th> <% if (currentUser && currentUser.role === 'Owner' && currentUser.companyId === company.companyId) { %><th>Действие</th><% } %> </tr> </thead>
                            <tbody>
                                <% staffList.forEach(staff => { %>
                                    <tr>
                                        <td><%= staff.Username %></td>
                                        <td><%= staff.FullName || 'Имя не указано' %></td>
                                        <% if (currentUser && currentUser.role === 'Owner' && currentUser.companyId === company.companyId) { %>
                                            <td>
                                                <form id="removeStaffForm-<%= staff.Username %>" action="/company/staff/remove" method="POST" onsubmit="return confirm('Удалить помощника <%= staff.Username %>?')">
                                                     <input type="hidden" name="staffUsername" value="<%= staff.Username %>">
                                                     <button type="submit" class="btn btn-delete btn-small"> <span class="button-text">Удалить</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button>
                                                 </form>
                                            </td>
                                         <% } %>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <p>Помощники еще не добавлены.</p>
                <% } %>

                <% if (currentUser && currentUser.role === 'Owner' && currentUser.companyId === company.companyId) { %>
                    <form id="addStaffForm" action="/company/staff/add" method="POST" class="add-staff-form">
                         <h4>Добавить помощника</h4>
                         <div class="form-group"> <label for="staffUsername">Логин пользователя *</label> <input type="text" id="staffUsername" name="staffUsername" required placeholder="Логин существующего пользователя"> </div>
                         <button type="submit" class="btn btn-primary btn-small"> <span class="button-text">Добавить</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button>
                         <small>Пользователь должен быть зарегистрирован и не Owner/Admin.</small>
                    </form>
                 <% } %>
            </section>

            <!-- Секция Объектов Компании -->
             <section class="company-section company-properties-section">
                <h2><i class="fas fa-city"></i> Объекты Компании (<%= locals.properties ? properties.length : 0 %>)</h2>
                 <% if (locals.properties && properties.length > 0) { %>
                     <div class="table-responsive">
                         <table class="data-table">
                            <thead><tr><th>Название</th><th>Тип</th><th>Адрес</th><th>Статус</th><th>Действия</th></tr></thead>
                             <tbody>
                                 <% properties.forEach(prop => { %>
                                     <tr>
                                         <td><a href="/properties/<%= prop.Id %>"><%= prop.Title %></a></td>
                                         <td><%= prop.Type %></td>
                                         <td><%= prop.Address %></td>
                                         <td><span class="status-label <%= prop.IsAvailable ? 'status-active' : 'status-other' %>"><%= prop.IsAvailable ? 'Доступен' : 'Недоступен' %></span></td>
                                         <td><a href="/properties/edit/<%= prop.Id %>" class="btn btn-edit btn-small">Правка</a></td>
                                     </tr>
                                 <% }) %>
                             </tbody>
                         </table>
                     </div>
                 <% } else { %>
                     <p>У компании пока нет добавленных объектов.</p>
                 <% } %>
                 <% if (currentUser && (currentUser.role === 'Owner' || currentUser.role === 'Staff') && currentUser.companyId === company.companyId) { %>
                    <div style="margin-top: 20px;">
                        <a href="/properties/add" class="btn btn-success">Добавить новый объект</a>
                    </div>
                 <% } %>
             </section>

             <!-- Секция Аренд Компании -->
             <section class="company-section company-rentals-section">
                 <h2><i class="fas fa-file-signature"></i> Аренды по Объектам (<%= locals.bookings ? bookings.length : 0 %>)</h2>
                 <% if (locals.bookings && bookings.length > 0) { %>
                    <div class="table-responsive">
                         <table class="data-table">
                             <thead><tr><th>Объект</th><th>Арендатор</th><th>Даты</th><th>Статус</th><th>Сумма</th><th>Действия</th></tr></thead>
                             <tbody>
                                 <% bookings.forEach(booking => { %>
                                     <% let statusClass = 'status-other'; if (booking.Status === 'Активна') statusClass = 'status-active'; else if (booking.Status === 'Отменена' || booking.Status === 'Аннулирована') statusClass = 'status-cancelled'; %>
                                     <% const bookingProperty = locals.properties?.find(p => p.Id === booking.PropertyId); %>
                                     <%# Для имени арендатора нужно загружать ВСЕХ юзеров, а не только стафф %>
                                     <%# Пока оставим ID, если не стафф %>
                                     <% const bookingTenantInfo = locals.staffList?.find(s => s.Username === booking.UserId) || { FullName: booking.UserId }; %>
                                     <tr>
                                         <td title="<%= bookingProperty?.Title || 'Объект?' %>"><a href="/properties/<%= booking.PropertyId %>"><%= bookingProperty?.Title?.substring(0, 25) || '???' %><% if(bookingProperty?.Title?.length > 25){ %>...<% } %></a></td>
                                         <td title="<%= bookingTenantInfo.FullName %>"><%= bookingTenantInfo.FullName?.substring(0, 20) %><% if(bookingTenantInfo.FullName?.length > 20){ %>...<% } %></td>
                                         <td><%= booking.StartDate ? new Date(booking.StartDate).toLocaleDateString('ru-RU') : '?' %> - <%= booking.EndDate ? new Date(booking.EndDate).toLocaleDateString('ru-RU') : '?' %></td>
                                         <td><span class="status-label <%= statusClass %>"><%= booking.Status %></span></td>
                                         <td><%= booking.TotalCost ? new Intl.NumberFormat('ru-RU', {style:'currency', currency:'RUB'}).format(booking.TotalCost) : '?' %></td>
                                         <td>
                                             <% if (booking.Status === 'Активна' && currentUser && (currentUser.role === 'Owner' || currentUser.role === 'Staff') && currentUser.companyId === company.companyId) { %>
                                                <form id="cancelRentalForm-<%= booking.Id %>" action="/rentals/<%= booking.Id %>/cancel" method="POST" onsubmit="return confirm('Аннулировать аренду?')" style="display: inline;">
                                                     <button type="submit" class="btn btn-warning btn-small"> <span class="button-text">Аннул.</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button>
                                                 </form>
                                             <% } else if (currentUser.role === 'Admin' && booking.Status !== 'Активна') { %>
                                                 <form id="deleteRentalForm-<%= booking.Id %>" action="/rentals/<%= booking.Id %>/delete" method="POST" onsubmit="return confirm('Удалить запись?')" style="display: inline;">
                                                     <button type="submit" class="btn btn-delete btn-small"> <span class="button-text">Удалить</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button>
                                                 </form>
                                             <% } else { %> - <% } %>
                                         </td>
                                     </tr>
                                 <% }) %>
                             </tbody>
                         </table>
                     </div>
                 <% } else { %>
                     <p>По объектам компании еще не было аренд.</p>
                 <% } %>
                 <div style="margin-top: 20px;">
                    <a href="/rentals" class="btn btn-secondary">Перейти к общему управлению арендами</a>
                 </div>
             </section>

        <% } else { %>
             <p>Не удалось загрузить данные компании.</p>
             <a href="/" class="btn btn-secondary">На главную</a>
        <% } %>
    </main>

    <%- include('partials/footer') %>
    <script>
        function toggleEditMode(isEditing) { const editSection = document.getElementById('editCompanySection'); const editButton = document.querySelector('.edit-company-btn'); if(editSection) editSection.classList.toggle('hidden', !isEditing); if(editButton) editButton.style.display = isEditing ? 'none' : 'inline-block'; }
        const editLogoInput = document.getElementById('editCompanyLogo'); const editLogoPreview = document.getElementById('editLogoPreview'); if (editLogoInput && editLogoPreview) { editLogoInput.addEventListener('change', function(event) { const file = event.target.files[0]; if (file && file.type.startsWith('image/')) { if (file.size > 1048576) { alert('Файл > 1MB'); event.target.value = null; editLogoPreview.style.display = 'none'; return; } const reader = new FileReader(); reader.onload = (e) => { editLogoPreview.src = e.target.result; editLogoPreview.style.display = 'block'; }; reader.readAsDataURL(file); } else { editLogoPreview.src = '#'; editLogoPreview.style.display = 'none'; if(file) event.target.value = null; } }); }
        function setupFormSpinner(formId, buttonTextLoading = 'Обработка...') { const form = document.getElementById(formId); if (!form) return; const button = form.querySelector('button[type="submit"]'); if (!button) return; const buttonTextSpan = button.querySelector('.button-text'); const originalText = buttonTextSpan?.textContent || button.textContent; form.addEventListener('submit', (event) => { if (event.submitter && event.submitter !== button) return; if (form.checkValidity()) { if(buttonTextSpan) buttonTextSpan.textContent = buttonTextLoading; button.disabled = true; } else { setTimeout(() => { if(buttonTextSpan) buttonTextSpan.textContent = originalText; button.disabled = false; }, 100); } }); } // Добавлен setTimeout для сброса при невалидности
        setupFormSpinner('companyEditForm', 'Сохранение...');
        setupFormSpinner('addStaffForm', 'Добавление...');
        document.querySelectorAll('.staff-table form').forEach(form => setupFormSpinner(form.id || `form-staff-remove-${Math.random().toString(36).substring(7)}`, 'Удаление...')); // Добавлен ID для уникальности
        document.querySelectorAll('.company-rentals-section form').forEach(form => setupFormSpinner(form.id || `form-rental-action-${Math.random().toString(36).substring(7)}`, '...')); // Для кнопок аренд
        function showCompanyJsMessage(type, text) { const container = document.getElementById('js-company-messages'); if (!container) return; const messageDiv = document.createElement('div'); messageDiv.className = `flash-message flash-${type}`; messageDiv.innerHTML = `${text} <button type="button" class="close-flash" onclick="this.parentElement.remove()">×</button>`; container.innerHTML = ''; container.appendChild(messageDiv); setTimeout(() => { if(messageDiv) messageDiv.remove(); }, 5000); }
    </script>
</body>
</html>