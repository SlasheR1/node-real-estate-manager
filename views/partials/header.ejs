<!-- views/partials/header.ejs -->
<header class="main-header">
    <nav class="header-content">
        <a href="/" class="brand-logo">
            <img src="/images/logo.svg" alt="Real Estate Logo" class="logo-img">
            <span>RealEstate</span>
        </a>

        <div class="header-right">
            <div class="nav-links main-nav-links">
                <%# –û–±—â–∏–µ —Å—Å—ã–ª–∫–∏ %>
                <a href="/properties">–û–±—ä–µ–∫—Ç—ã</a>

                <%# –°—Å—ã–ª–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π %>
                <% if (currentUser) { %>
                    <%# –î–ª—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ %>
                    <% if (currentUser.role === 'Tenant') { %>
                        <a href="/bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</a>
                    <% } %>

                    <%# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê—Ä–µ–Ω–¥–∞–º–∏ (–¥–ª—è –≤—Å–µ—Ö –∫—Ä–æ–º–µ Tenant) %>
                    <% if (currentUser.role === 'Admin' || currentUser.role === 'Owner' || currentUser.role === 'Staff') { %>
                        <a href="/rentals">–£–ø—Ä. –ê—Ä–µ–Ω–¥–∞–º–∏</a>
                    <% } %>

                    <%# –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç (–¥–ª—è Admin –∏ Owner —Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º) %>
                    <% if (currentUser.role === 'Admin' || (currentUser.role === 'Owner' && currentUser.companyProfileCompleted)) { %>
                         <a href="/properties/add">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</a>
                    <% } %>

                    <%# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–µ–π (–¥–ª—è Owner –∏ Staff —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º companyId) %>
                    <% if ((currentUser.role === 'Owner' || currentUser.role === 'Staff') && currentUser.companyId) { %>
                          <a href="/company/manage">–ú–æ—è –ö–æ–º–ø–∞–Ω–∏—è</a>
                     <% } %>

                    <%# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è Admin) %>
                    <% if (currentUser.role === 'Admin') { %>
                        <a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                    <% } %>
                <% } else { %>
                    <%# –°—Å—ã–ª–∫–∏ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö %>
                    <a href="/login">–í–æ–π—Ç–∏</a>
                    <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                <% } %>
            </div>

            <%# –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö %>
            <% if (currentUser) { %>
                <div class="user-profile">
                    <a href="/profile" class="profile-link" title="–ü—Ä–æ—Ñ–∏–ª—å">
                        <div class="user-info">
                            <span class="user-name" id="headerUserName"><%= currentUser.fullName || currentUser.username %></span>
                            <div class="user-sub-info">
                                <span class="user-role" id="headerUserRole"><%= currentUser.role %></span>
                                <%# –õ–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ç–æ–ª—å–∫–æ –¥–ª—è Tenant %>
                                <% if (currentUser.role === 'Tenant') { %>
                                    <span class="user-balance profile-sub-optional" id="headerUserBalance"><%= new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(currentUser.balance ?? 0) %></span>
                                <% } %>
                                <%# –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è Owner/Staff %>
                                <% if ((currentUser.role === 'Owner' || currentUser.role === 'Staff') && currentUser.companyName) { %>
                                    <span class="user-company profile-sub-optional" id="headerUserCompany" title="<%= currentUser.companyName %>" style="display: inline-flex; align-items: center; background-color: #e9ecef; padding: 1px 6px; border-radius: 4px; font-size: 0.75rem; color: #4a5568; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        <i class="fas fa-briefcase" style="font-size: 0.8em; margin-right: 4px; opacity: 0.7;"></i>
                                        <span id="headerUserCompanyName" style="overflow: hidden; text-overflow: ellipsis;"><%= currentUser.companyName %></span>
                                    </span>
                                <% } else { %>
                                    <%# –ü—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Staff/Owner –±–µ–∑ –∫–æ–º–ø–∞–Ω–∏–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—É–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å –∏–º—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ %>
                                     <span class="user-company profile-sub-optional" id="headerUserCompany" style="display: none;">
                                        <i class="fas fa-briefcase" style="font-size: 0.8em; margin-right: 4px; opacity: 0.7;"></i>
                                        <span id="headerUserCompanyName"></span>
                                     </span>
                                <% } %>
                            </div>
                        </div>
                        <div class="avatar-container" id="headerAvatarContainer">
                            <%
                                let avatarSrc = '/images/placeholder-avatar.png';
                                let isDataUri = false;
                                if (currentUser.imageData && typeof currentUser.imageData === 'string') {
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º Data URI
                                    if (currentUser.imageData.length < 2 * 1024 * 1024) { // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç 2MB
                                        try {
                                            let t = currentUser.imageData.startsWith('/9j/') ? 'image/jpeg' : 'image/png';
                                            avatarSrc = `data:${t};base64,${currentUser.imageData}`;
                                            isDataUri = true;
                                        } catch(e) {
                                            console.error("Error creating avatar data URI in header:", e);
                                        }
                                    } else {
                                        console.warn("Header avatar skipped: Image data too large for Data URI.");
                                        // –ú–æ–∂–Ω–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø–æ URL, –µ—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∏ —Ç–∞–∫
                                        // avatarSrc = '/path/to/placeholder/or/fallback';
                                    }
                                }
                            %>
                            <img src="<%= avatarSrc %>" alt="Avatar" class="user-avatar" id="headerUserAvatar" data-is-data-uri="<%= isDataUri %>">
                        </div>
                    </a>
                    <form action="/logout" method="POST" class="logout-form">
                         <button type="submit" class="btn btn-logout" title="–í—ã–π—Ç–∏">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2h-5v-2h5V7l5 5-5 5zM14 20H6c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h8v2H6v12h8v2z"></path></svg>
                         </button>
                     </form>
                </div>
            <% } %>
        </div>
        <%# –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é (—Å—Ç–∏–ª—è–º–∏ —Å–∫—Ä—ã—Ç–∞/–ø–æ–∫–∞–∑–∞–Ω–∞) %>
        <button class="mobile-nav-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" style="display: none;">‚ò∞</button>
    </nav>
    <!-- ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ===== -->
    <div id="updateModalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1050; align-items: center; justify-content: center;">
        <div id="updateModalContent" class="" style="background-color: #fff; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); width: 90%; max-width: 550px; text-align: center; border-top: 5px solid #5bc0de;">
            <h2 id="updateModalTitle" style="margin-top: 0; margin-bottom: 15px; color: #2c3e50; font-size: 1.7rem; font-weight: 600;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
            <p id="updateModalMessage" style="color: #555; margin-bottom: 25px; line-height: 1.6; font-size: 1.05rem;">–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...</p>
            <div id="updateProgressContainer" style="display: none; margin-bottom: 25px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; height: 12px; border: 1px solid #dee2e6;">
                <div id="updateProgressBar" style="width: 0%; height: 100%; background-color: #5cb85c; background-image: linear-gradient(45deg, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; border-radius: 4px; transition: width 0.2s linear; animation: progress-bar-stripes 1s linear infinite;"></div>
            </div>
            <style> @keyframes progress-bar-stripes{from{background-position:1rem 0}to{background-position:0 0}} </style>
            <div id="updateModalActions">
                 <button id="updateModalRestartButton" class="btn btn-primary" style="display: none; padding: 12px 30px; font-size: 1rem; margin: 5px; min-width: 150px;">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                 <button id="updateModalCloseButton" class="btn btn-secondary" style="display: none; padding: 12px 20px; font-size: 1rem; margin: 5px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
             <small id="updateErrorDetails" style="display: none; color: #dc3545; margin-top: 15px; display: block; font-size: 0.9em; line-height: 1.5; word-wrap: break-word;"></small>
        </div>
    </div>
    <!-- ============================================================= -->
</header>

<%# --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ª–æ–≥–∏–∫–∞ Socket.IO –∫–ª–∏–µ–Ω—Ç–∞ –ò AutoUpdater --- %>
<% if (currentUser) { %>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ JS-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function showJsNotification(type, text, duration = 7000, playSound = true) {
            // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø–æ—Ç–æ–º –æ–±—â–∏–π #js-messages, –ø–æ—Ç–æ–º main, –ø–æ—Ç–æ–º body.
            const container = document.getElementById('js-messages-rentals')
                            || document.getElementById('js-messages-container') // bookings-list
                            || document.getElementById('js-review-messages')   // property-details (reviews)
                            || document.getElementById('js-messages-user-list')// users-list
                            || document.getElementById('js-messages-user-form')// user-add-edit
                            || document.getElementById('js-messages')          // profile-edit
                            || document.getElementById('js-company-messages')  // company-management
                            || document.body.querySelector('main.container')
                            || document.body; // Fallback
            if (!container) { console.warn("No suitable container found for JS notification."); return; }

             // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫
             if (playSound) { try { const audio = new Audio('/sounds/notification.mp3'); audio.play().catch(e => console.warn("Audio playback failed (likely user interaction required):", e)); } catch (e) { console.error("Error playing sound:", e); } }

             // –°–æ–∑–¥–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
             const notifId = 'notif-' + Date.now(); // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
             const notifDiv = document.createElement('div');
             notifDiv.id = notifId;
             notifDiv.className = `flash-message flash-${type}`;
             // –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
             notifDiv.style.cssText = 'opacity:0; transform:translateY(-10px); transition: opacity 0.5s ease, transform 0.5s ease; margin-top: 10px; cursor: pointer; z-index: 1056; position: relative;';
             // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
             notifDiv.innerHTML = `${text} <button type="button" class="close-flash" onclick="event.stopPropagation(); document.getElementById('${notifId}')?.remove();">√ó</button>`;
             // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
             notifDiv.addEventListener('click', () => notifDiv.remove());

             // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
             if (container.firstChild) { container.insertBefore(notifDiv, container.firstChild); }
             else { container.appendChild(notifDiv); }

             // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
             requestAnimationFrame(() => { // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
                 notifDiv.style.opacity = '1';
                 notifDiv.style.transform = 'translateY(0)';
             });

             // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ duration
             setTimeout(() => {
                 const currentNotif = document.getElementById(notifId);
                 if (currentNotif) {
                     currentNotif.style.opacity = '0';
                     currentNotif.style.transform = 'translateY(-10px)';
                     // –£–¥–∞–ª—è–µ–º –∏–∑ DOM –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–∫—Ä—ã—Ç–∏—è
                     setTimeout(() => currentNotif.remove(), 500);
                 }
             }, duration);
         }

        document.addEventListener('DOMContentLoaded', () => {
            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO ---
            try {
                console.log('[Socket.IO Client] Initializing...');
                const socket = io({ reconnectionAttempts: 5, reconnectionDelay: 3000 });
                let currentUsername = null;
                try { currentUsername = decodeURIComponent("<%= encodeURIComponent(currentUser.username) %>"); } catch(e) { console.error("Could not get username from EJS:", e); }

                if (!currentUsername) { console.error("[Socket.IO Client] Username missing."); }
                else {
                  socket.on('connect', () => { console.log(`[Socket.IO Client] Connected: ${socket.id}. Registering: ${currentUsername}`); socket.emit('register_user', currentUsername); });
                  socket.on('disconnect', (reason) => { console.warn(`[Socket.IO Client] Disconnected. Reason: ${reason}`); });
                  socket.on('connect_error', (err) => { console.error(`[Socket.IO Client] Connection Error: ${err.message}`); });

                  // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---

                  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è Tenant)
                  socket.on('balance_updated', (newBalance) => {
                    const userRoleElement = document.getElementById('headerUserRole');
                    const isTenant = userRoleElement && userRoleElement.textContent === 'Tenant';
                    if (isTenant) {
                        console.log(`[Socket.IO Client] Event 'balance_updated' received: ${newBalance}`);
                        const balanceEl = document.getElementById('headerUserBalance'); // –ë–∞–ª–∞–Ω—Å –≤ —à–∞–ø–∫–µ
                        const profileBalanceEl = document.querySelector('.profile-details .balance strong'); // –ë–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä. –ø—Ä–æ—Ñ–∏–ª—è
                        const formattedBalance = (typeof newBalance === 'number')
                            ? new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(newBalance)
                            : '–û—à–∏–±–∫–∞';

                        if (balanceEl) { balanceEl.textContent = formattedBalance; }
                        if (profileBalanceEl) { profileBalanceEl.textContent = formattedBalance; } // –û–±–Ω–æ–≤–ª—è–µ–º –∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è

                    } else { console.log("[Socket.IO Client] Ignored 'balance_updated' for non-tenant."); }
                  });

                  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
                  socket.on('avatar_updated', () => {
                     console.log(`[Socket.IO Client] Event 'avatar_updated' received for ${currentUsername}.`);
                     const headerAvatarImg = document.getElementById('headerUserAvatar');
                     const profileAvatarImg = document.querySelector('.profile-avatar'); // –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è

                     // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –≤ —à–∞–ø–∫–µ
                     if (headerAvatarImg) {
                         // –ï—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä –±—ã–ª data URI, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
                         if (headerAvatarImg.dataset.isDataUri === 'true') {
                             showJsNotification('info', '–í–∞—à –∞–≤–∞—Ç–∞—Ä –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.', 7000, false);
                             // –ú–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å—Ä–∞–∑—É
                             headerAvatarImg.src = '/images/placeholder-avatar.png';
                             headerAvatarImg.dataset.isDataUri = 'false';
                         } else {
                             // –ï—Å–ª–∏ –±—ã–ª URL (–∏–ª–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä), –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å timestamp
                             headerAvatarImg.src = headerAvatarImg.src.split('?')[0] + '?t=' + new Date().getTime();
                         }
                     }

                     // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è
                     if (profileAvatarImg) {
                         if (profileAvatarImg.src.startsWith('data:')) {
                             // –ï—Å–ª–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è –±—ã–ª data URI, —Ç–æ–∂–µ –ª—É—á—à–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                             // (–º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–¥–µ—Å—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                             profileAvatarImg.src = '/images/placeholder-avatar.png';
                         } else {
                             profileAvatarImg.src = profileAvatarImg.src.split('?')[0] + '?t=' + new Date().getTime();
                         }
                     }
                      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
                     const editProfileAvatarImg = document.querySelector('.current-avatar-display img');
                     if (editProfileAvatarImg) {
                          if (editProfileAvatarImg.src.startsWith('data:')) {
                              editProfileAvatarImg.src = '/images/placeholder-avatar.png'; // –°–±—Ä–æ—Å –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                              // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä.
                          } else {
                              editProfileAvatarImg.src = editProfileAvatarImg.src.split('?')[0] + '?t=' + new Date().getTime();
                          }
                          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å "—Ç–µ–∫—É—â–∏–º" –∞–≤–∞—Ç–∞—Ä–æ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º "–Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞"
                          document.getElementById('currentAvatarContainer')?.classList.remove('hidden');
                          document.getElementById('noAvatarMessage')?.classList.add('hidden');
                          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ (–æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞, –µ—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –Ω–µ –±—ã–ª–æ –∞–≤–∞—Ç–∞—Ä–∞)
                          const resetButton = document.getElementById('resetAvatarBtn');
                          if(resetButton && resetButton.parentElement) resetButton.parentElement.style.display = 'block'; // –ò–ª–∏ –∫–∞–∫ —Ç–∞–º –æ–Ω–∞ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è
                     }


                  });

                  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
                  socket.on('profile_data_updated', (data) => {
                     console.log(`[Socket.IO Client] Event 'profile_data_updated' received:`, data);
                     if (!data) return;

                     const nameEl = document.getElementById('headerUserName');
                     const roleEl = document.getElementById('headerUserRole');
                     const companyContainer = document.getElementById('headerUserCompany');
                     const companyNameSpan = document.getElementById('headerUserCompanyName');
                     const profileNameEl = document.querySelector('.profile-name-role h2'); // –ò–º—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è
                     const profileRoleEl = document.querySelector('.profile-name-role .role'); // –†–æ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è

                     // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è
                     if (nameEl && data.fullName) { nameEl.textContent = data.fullName; }
                     if (profileNameEl && data.fullName) { profileNameEl.textContent = data.fullName; }

                     // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å
                     if (roleEl && data.role) { roleEl.textContent = data.role; }
                     if (profileRoleEl && data.role) { profileRoleEl.textContent = data.role; }

                     // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–ø–∞–Ω–∏—é
                     if (companyContainer && companyNameSpan) {
                         if (data.companyName && (data.role === 'Owner' || data.role === 'Staff')) {
                              companyNameSpan.textContent = data.companyName;
                              companyContainer.title = data.companyName;
                              companyContainer.style.display = 'inline-flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                         } else {
                              companyContainer.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º
                         }
                     }

                      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç"
                      const addPropertyLink = document.querySelector('.main-nav-links a[href="/properties/add"]');
                      if (addPropertyLink) {
                          const canAdd = data.role === 'Admin' || (data.role === 'Owner' && data.companyProfileCompleted === true);
                          addPropertyLink.style.display = canAdd ? 'inline' : 'none';
                      }
                      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏ "–ú–æ—è –∫–æ–º–ø–∞–Ω–∏—è"
                       const myCompanyLink = document.querySelector('.main-nav-links a[href="/company/manage"]');
                       if (myCompanyLink) {
                           const canManageCompany = (data.role === 'Owner' || data.role === 'Staff') && data.companyId;
                           myCompanyLink.style.display = canManageCompany ? 'inline' : 'none';
                       }
                       // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
                       const usersLink = document.querySelector('.main-nav-links a[href="/users"]');
                       if (usersLink) {
                            usersLink.style.display = (data.role === 'Admin') ? 'inline' : 'none';
                       }
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏ "–£–ø—Ä. –∞—Ä–µ–Ω–¥–∞–º–∏"
                        const rentalsLink = document.querySelector('.main-nav-links a[href="/rentals"]');
                        if (rentalsLink) {
                             rentalsLink.style.display = (data.role === 'Admin' || data.role === 'Owner' || data.role === 'Staff') ? 'inline' : 'none';
                        }
                         // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Å—ã–ª–∫–∏ "–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
                         const bookingsLink = document.querySelector('.main-nav-links a[href="/bookings"]');
                         if (bookingsLink) {
                             bookingsLink.style.display = (data.role === 'Tenant') ? 'inline' : 'none';
                         }


                     // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                     showJsNotification('info', '–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.', 5000, false);
                  });

                  // –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
                  socket.on('account_deleted', (data) => {
                     console.warn(`[Socket.IO Client] Event 'account_deleted' received:`, data?.message);
                     if(socket.connected) { socket.disconnect(); }
                     alert(data?.message || '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
                     // –§–æ—Ä—Å–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
                     const logoutForm = document.createElement('form');
                     logoutForm.method = 'POST'; logoutForm.action = '/logout';
                     document.body.appendChild(logoutForm);
                     logoutForm.submit();
                  });

                 // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è
                 socket.on('password_reset_notification', (data) => {
                     console.log(`[Socket.IO Client] Event 'password_reset_notification' received.`);
                     showJsNotification('warning', data?.message || '–í–∞—à –ø–∞—Ä–æ–ª—å –±—ã–ª —Å–±—Ä–æ—à–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–º–µ–Ω–∏—Ç–µ –µ–≥–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ.', 10000, true);
                     // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã—Ö–æ–¥–∞, –µ—Å–ª–∏ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è
                     // alert("–í–∞—à –ø–∞—Ä–æ–ª—å –±—ã–ª —Å–±—Ä–æ—à–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º.");
                     // const logoutForm = document.createElement('form'); logoutForm.method = 'POST'; logoutForm.action = '/logout'; document.body.appendChild(logoutForm); logoutForm.submit();
                 });


                 // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
                 socket.on('booking_confirmed', (data) => { console.log("[Socket.IO Client] Event 'booking_confirmed':", data); showJsNotification('success', `‚úÖ –ë—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>" <strong>–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</strong>!`, 7000, true); const row = document.getElementById(`booking-row-${data.bookingId}`); if (row && window.location.pathname === '/bookings') { const statusCell = row.querySelector('.status-cell .status-label'); const actionsCell = row.querySelector('.actions-cell'); if (statusCell) { statusCell.textContent = '–ê–∫—Ç–∏–≤–Ω–∞'; statusCell.className = 'status-label status-active'; statusCell.title = '–ê–∫—Ç–∏–≤–Ω–∞'; } if (actionsCell) { const form = actionsCell.querySelector('form'); if(form) form.dataset.currentStatus = '–ê–∫—Ç–∏–≤–Ω–∞'; } } });
                 socket.on('booking_rejected', (data) => { console.log("[Socket.IO Client] Event 'booking_rejected':", data); const reasonText = data.reason ? ` –ü—Ä–∏—á–∏–Ω–∞: ${data.reason}` : ''; showJsNotification('warning', `‚ùå –ó–∞–ø—Ä–æ—Å #${data.bookingId?.substring(0,6)} –Ω–∞ "<strong>${data.propertyTitle || '?'}</strong>" <strong>–æ—Ç–∫–ª–æ–Ω–µ–Ω</strong>.${reasonText}`, 10000, true); const row = document.getElementById(`booking-row-${data.bookingId}`); if (row && window.location.pathname === '/bookings') { const statusCell = row.querySelector('.status-cell'); const actionsCell = row.querySelector('.actions-cell'); if (statusCell) { statusCell.innerHTML = `<span class="status-label status-rejected" title="–û—Ç–∫–ª–æ–Ω–µ–Ω–∞">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</span>`; if(data.reason) { statusCell.innerHTML += ` <i class="fas fa-info-circle" title="${data.reason}" style="margin-left: 5px; color: #d35400; cursor: help;"></i>`; } } if (actionsCell) { actionsCell.innerHTML = '<span>-</span>'; } } });
                 socket.on('booking_cancelled_by_owner', (data) => { console.log("[Socket.IO Client] Event 'booking_cancelled_by_owner':", data); showJsNotification('error', `‚ùó –ë—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>" –±—ã–ª–∞ <strong>–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞</strong> –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.`, 10000, true); const row = document.getElementById(`booking-row-${data.bookingId}`); if (row && window.location.pathname === '/bookings') { const statusCell = row.querySelector('.status-cell .status-label'); const actionsCell = row.querySelector('.actions-cell'); if (statusCell) { statusCell.textContent = '–ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞'; statusCell.className = 'status-label status-annulled'; statusCell.title = '–ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞'; } if (actionsCell) { actionsCell.innerHTML = '<span>-</span>'; } } });
                 socket.on('new_booking_pending', (data) => { console.log("[Socket.IO Client] Event 'new_booking_pending':", data); if (!window.location.pathname.startsWith('/rentals')) { showJsNotification('info', `üì¨ –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>" –æ—Ç ${data.tenantName}. <a href="/rentals" style='color:inherit; font-weight:bold;'>–ö –∞—Ä–µ–Ω–¥–∞–º</a>`, 15000, true); } else { /* –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∞—Ä–µ–Ω–¥, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ /rentals */ } });
                 socket.on('pending_booking_cancelled', (data) => { console.log("[Socket.IO Client] Event 'pending_booking_cancelled':", data); showJsNotification('warning', `‚ùå –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä <strong>${data.tenantName}</strong> –æ—Ç–º–µ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å #${data.bookingId?.substring(0,6)} –Ω–∞ "<strong>${data.propertyTitle || '?'}</strong>".`, 7000, true); const row = document.getElementById(`rental-row-${data.bookingId}`); if (row && window.location.pathname.startsWith('/rentals')) { row.remove(); const pendingCountSpan = document.getElementById('pendingCount'); if(pendingCountSpan) { let count = parseInt(pendingCountSpan.textContent || '0') - 1; pendingCountSpan.textContent = Math.max(0, count); } const pendingBody = document.getElementById('pendingBookingsTableBody'); const noPendingMsg = pendingBody?.closest('.rentals-section')?.querySelector('.no-bookings-message'); if(pendingBody && noPendingMsg) { noPendingMsg.style.display = pendingBody.rows.length === 0 ? 'block' : 'none'; } } });
                 socket.on('active_booking_cancelled', (data) => { console.log("[Socket.IO Client] Event 'active_booking_cancelled':", data); showJsNotification('error', `üö´ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä <strong>${data.tenantName}</strong> –æ—Ç–º–µ–Ω–∏–ª –∞–∫—Ç–∏–≤–Ω—É—é –±—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>".`, 10000, true); const row = document.getElementById(`rental-row-${data.bookingId}`); if (row && window.location.pathname.startsWith('/rentals')) { const statusCell = row.querySelector('.status-cell .status-label'); const actionsCell = row.querySelector('.actions-cell'); if (statusCell) { statusCell.textContent = '–û—Ç–º–µ–Ω–µ–Ω–∞'; statusCell.className = 'status-label status-cancelled'; statusCell.title = '–û—Ç–º–µ–Ω–µ–Ω–∞'; } row.dataset.status = '–û—Ç–º–µ–Ω–µ–Ω–∞'; if (actionsCell) { actionsCell.innerHTML = ''; const isAdmin = currentUser.role === 'Admin'; if (isAdmin) { actionsCell.innerHTML = `<form class="rental-action-form" data-action="delete" data-booking-id="${data.bookingId}" action="/rentals/${data.bookingId}/delete" method="POST"><button type="submit" class="btn btn-small btn-delete"> <span class="button-text">–£–¥–∞–ª–∏—Ç—å</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button></form>`; } else { actionsCell.innerHTML = '<span>-</span>'; } } } });
                 // --- –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Socket.IO ---
                } // –ö–æ–Ω–µ—Ü else –¥–ª—è currentUsername

            } catch(e) {
                console.error("[Socket.IO Client] Error setting up listeners:", e);
            }

            // --- –ö–û–î –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ú–û–î–ê–õ–¨–ù–´–ú –û–ö–ù–û–ú –û–ë–ù–û–í–õ–ï–ù–ò–Ø (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
            const modalOverlay = document.getElementById('updateModalOverlay'); const modalContent = document.getElementById('updateModalContent'); const modalTitle = document.getElementById('updateModalTitle'); const modalMessage = document.getElementById('updateModalMessage'); const progressContainer = document.getElementById('updateProgressContainer'); const progressBar = document.getElementById('updateProgressBar'); const restartButtonModal = document.getElementById('updateModalRestartButton'); const closeButtonModal = document.getElementById('updateModalCloseButton'); const errorDetails = document.getElementById('updateErrorDetails'); let listeners = {}; let updateInfoGlobal = null;
            function setModalStatusClass(statusClass) { if (modalContent) { modalContent.classList.remove('status-info', 'status-available', 'status-downloading', 'status-ready', 'status-error'); modalContent.classList.add(`status-${statusClass}`); const colors = { info: '#5bc0de', available: '#f0ad4e', downloading: '#f0ad4e', ready: '#5cb85c', error: '#d9534f' }; modalContent.style.borderTopColor = colors[statusClass] || '#5bc0de'; } }
            function showUpdateModal(statusClass = 'info') { if (!modalOverlay || !modalContent) { console.error("[Renderer Updater] –û–®–ò–ë–ö–ê –≤ showUpdateModal: modalOverlay –∏–ª–∏ modalContent –Ω–µ –Ω–∞–π–¥–µ–Ω!"); return; } setModalStatusClass(statusClass); modalOverlay.style.display = 'flex'; requestAnimationFrame(() => { modalOverlay.style.opacity = '1'; modalContent.style.opacity = '1'; modalContent.style.transform = 'scale(1)'; }); console.log("[Renderer Updater] Modal shown."); }
            function hideUpdateModal() { if (modalOverlay) { modalOverlay.style.opacity = '0'; if (modalContent) { modalContent.style.opacity = '0'; modalContent.style.transform = 'scale(0.95)'; } setTimeout(() => { modalOverlay.style.display = 'none'; if(progressBar) progressBar.style.width = '0%'; if(progressContainer) progressContainer.style.display = 'none'; if(restartButtonModal) restartButtonModal.style.display = 'none'; if(closeButtonModal) closeButtonModal.style.display = 'none'; if(errorDetails) errorDetails.style.display = 'none'; console.log("[Renderer Updater] Modal hidden."); }, 300); } else { console.error("[Renderer Updater] –û–®–ò–ë–ö–ê –≤ hideUpdateModal: modalOverlay –Ω–µ –Ω–∞–π–¥–µ–Ω!"); } }
            if (window.electronUpdater && modalOverlay && modalContent && modalTitle && modalMessage && progressContainer && progressBar && restartButtonModal && closeButtonModal && errorDetails) {
                console.log('[Renderer Updater] API –∏ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–π–¥–µ–Ω—ã. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π.');
                closeButtonModal.onclick = hideUpdateModal;
                restartButtonModal.onclick = () => { console.log('[Renderer Updater] <<< SENDING install-update >>> to main process.'); if(restartButtonModal) { restartButtonModal.textContent = '–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...'; restartButtonModal.disabled = true; } if(closeButtonModal) closeButtonModal.disabled = true; window.electronUpdater.send('install-update'); };
                listeners['update-status'] = window.electronUpdater.on('update-status', (message) => { console.log('[Renderer Updater] <<< RECEIVED update-status >>>', message); if (!message) { if (modalMessage && modalMessage.textContent === '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è.') { hideUpdateModal(); } return; } if (message !== `–í–µ—Ä—Å–∏—è ${updateInfoGlobal?.version} –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤–æ –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.`) { if(modalMessage) modalMessage.textContent = message; if(modalTitle) modalTitle.textContent = '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'; if(progressContainer) progressContainer.style.display = 'none'; if(restartButtonModal) restartButtonModal.style.display = 'none'; if(closeButtonModal) { closeButtonModal.style.display = 'inline-block'; closeButtonModal.disabled = false; } if(errorDetails) errorDetails.style.display = 'none'; showUpdateModal('info'); } if (message === '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è.') { setTimeout(hideUpdateModal, 5000); } });
                listeners['update-error'] = window.electronUpdater.on('update-error', (message) => { console.error('[Renderer Updater] <<< RECEIVED update-error >>>', message); if(modalTitle) modalTitle.textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'; if(modalMessage) modalMessage.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.'; if(errorDetails) { errorDetails.textContent = `–î–µ—Ç–∞–ª–∏: ${message}`; errorDetails.style.display = 'block'; } if(progressContainer) progressContainer.style.display = 'none'; if(restartButtonModal) restartButtonModal.style.display = 'none'; if(closeButtonModal) { closeButtonModal.style.display = 'inline-block'; closeButtonModal.disabled = false; } showUpdateModal('error'); });
                listeners['update-available'] = window.electronUpdater.on('update-available', (info) => { console.log('[Renderer Updater] <<< RECEIVED update-available >>>', info); updateInfoGlobal = info; if(modalTitle) modalTitle.textContent = `–î–æ—Å—Ç—É–ø–Ω–∞ –≤–µ—Ä—Å–∏—è ${info.version}`; if(modalMessage) modalMessage.textContent = '–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞...'; if(progressBar) progressBar.style.width = '0%'; if(progressContainer) progressContainer.style.display = 'block'; if(restartButtonModal) restartButtonModal.style.display = 'none'; if(closeButtonModal) { closeButtonModal.style.display = 'inline-block'; closeButtonModal.disabled = false; } if(errorDetails) errorDetails.style.display = 'none'; showUpdateModal('available'); });
                listeners['update-progress'] = window.electronUpdater.on('update-progress', (percent) => { if (Math.round(percent) % 5 === 0 || percent > 95 || percent < 5) { console.log('[Renderer Updater] <<< RECEIVED update-progress >>>', percent); } if(modalTitle) modalTitle.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'; if(modalMessage) modalMessage.textContent = `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ... ${percent}%`; if(progressBar) progressBar.style.width = `${percent}%`; if(progressContainer) progressContainer.style.display = 'block'; if(restartButtonModal) restartButtonModal.style.display = 'none'; if(closeButtonModal) { closeButtonModal.style.display = 'inline-block'; closeButtonModal.disabled = false; } if(errorDetails) errorDetails.style.display = 'none'; showUpdateModal('downloading'); });
                listeners['update-ready'] = window.electronUpdater.on('update-ready', (info) => { console.log('%c[Renderer Updater] <<< RECEIVED update-ready! >>>', 'color: green; font-size: 1.2em;', info); updateInfoGlobal = info; if(modalTitle) modalTitle.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${info.version} –≥–æ—Ç–æ–≤–æ!`; if(modalMessage) modalMessage.textContent = '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.'; if(progressContainer) progressContainer.style.display = 'none'; if(errorDetails) errorDetails.style.display = 'none'; if(restartButtonModal) { restartButtonModal.textContent = '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å'; restartButtonModal.disabled = false; restartButtonModal.style.display = 'inline-block'; console.log("[Renderer Updater] –ö–Ω–æ–ø–∫–∞ –ü–ï–†–ï–ó–ê–ü–£–°–¢–ò–¢–¨ –ø–æ–∫–∞–∑–∞–Ω–∞."); } else { console.error("[Renderer Updater] –ö–Ω–æ–ø–∫–∞ –ü–ï–†–ï–ó–ê–ü–£–°–¢–ò–¢–¨ –ù–ï –ù–ê–ô–î–ï–ù–ê –ø—Ä–∏ update-ready!"); } if(closeButtonModal) { closeButtonModal.style.display = 'none'; console.log("[Renderer Updater] –ö–Ω–æ–ø–∫–∞ –ó–ê–ö–†–´–¢–¨ —Å–∫—Ä—ã—Ç–∞."); } else { console.error("[Renderer Updater] –ö–Ω–æ–ø–∫–∞ –ó–ê–ö–†–´–¢–¨ –ù–ï –ù–ê–ô–î–ï–ù–ê –ø—Ä–∏ update-ready!"); } showUpdateModal('ready'); });
            } else { console.error('[Renderer Updater] Initialization FAILED. Checking components...'); /* ...–ª–æ–≥–∏ */ }
            // --- –ö–û–ù–ï–¶ –ö–û–î–ê –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ---

        }); // –ö–æ–Ω–µ—Ü DOMContentLoaded
    </script>
<% } %>