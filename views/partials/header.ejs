<!-- views/partials/header.ejs -->
<header class="main-header">
    <nav class="header-content">
        <a href="/" class="brand-logo">
            <img src="/images/logo.svg" alt="Real Estate Logo" class="logo-img">
            <span>RealEstate</span>
        </a>

        <div class="header-right">
            <div class="nav-links main-nav-links">
                <%# –û–±—â–∏–µ —Å—Å—ã–ª–∫–∏ %>
                <a href="/properties">–û–±—ä–µ–∫—Ç—ã</a>

                <%# –°—Å—ã–ª–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π %>
                <% if (currentUser) { %>
                    <%# –î–ª—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ %>
                    <% if (currentUser.role === 'Tenant') { %>
                        <a href="/bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</a>
                    <% } %>

                    <%# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê—Ä–µ–Ω–¥–∞–º–∏ (–¥–ª—è –≤—Å–µ—Ö –∫—Ä–æ–º–µ Tenant) %>
                    <% if (currentUser.role === 'Admin' || currentUser.role === 'Owner' || currentUser.role === 'Staff') { %>
                        <a href="/rentals">–£–ø—Ä. –ê—Ä–µ–Ω–¥–∞–º–∏</a>
                    <% } %>

                    <%# –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç (–¥–ª—è Admin –∏ Owner —Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º) %>
                    <% if (currentUser.role === 'Admin' || (currentUser.role === 'Owner' && currentUser.companyProfileCompleted)) { %>
                         <a href="/properties/add">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</a>
                    <% } %>

                    <%# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–µ–π (–¥–ª—è Owner –∏ Staff —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º companyId) %>
                    <% if ((currentUser.role === 'Owner' || currentUser.role === 'Staff') && currentUser.companyId) { %>
                          <a href="/company/manage">–ú–æ—è –ö–æ–º–ø–∞–Ω–∏—è</a>
                     <% } %>

                    <%# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è Admin) %>
                    <% if (currentUser.role === 'Admin') { %>
                        <a href="/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                    <% } %>
                <% } else { %>
                    <%# –°—Å—ã–ª–∫–∏ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö %>
                    <a href="/login">–í–æ–π—Ç–∏</a>
                    <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                <% } %>
            </div>

            <%# –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö %>
            <% if (currentUser) { %>
                <div class="user-profile">
                    <a href="/profile" class="profile-link" title="–ü—Ä–æ—Ñ–∏–ª—å">
                        <div class="user-info">
                            <span class="user-name" id="headerUserName"><%= currentUser.fullName || currentUser.username %></span>
                            <div class="user-sub-info">
                                <span class="user-role" id="headerUserRole"><%= currentUser.role %></span>
                                <%# –õ–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ç–æ–ª—å–∫–æ –¥–ª—è Tenant %>
                                <% if (currentUser.role === 'Tenant') { %>
                                    <span class="user-balance profile-sub-optional" id="headerUserBalance"><%= new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(currentUser.balance ?? 0) %></span>
                                <% } %>
                                <%# –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è Owner/Staff %>
                                <% if ((currentUser.role === 'Owner' || currentUser.role === 'Staff') && currentUser.companyName) { %>
                                    <span class="user-company profile-sub-optional" title="<%= currentUser.companyName %>" style="display: inline-flex; align-items: center; background-color: #e9ecef; padding: 1px 6px; border-radius: 4px; font-size: 0.75rem; color: #4a5568; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        <i class="fas fa-briefcase" style="font-size: 0.8em; margin-right: 4px; opacity: 0.7;"></i>
                                        <span style="overflow: hidden; text-overflow: ellipsis;"><%= currentUser.companyName %></span>
                                    </span>
                                <% } %>
                            </div>
                        </div>
                        <div class="avatar-container" id="headerAvatarContainer">
                            <%
                                let avatarSrc = '/images/placeholder-avatar.png';
                                if (currentUser.imageData && typeof currentUser.imageData === 'string') {
                                    // –î–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –¥–ª–∏–Ω—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏—Ö data URI
                                    if (currentUser.imageData.length < 2000000) { // –ü—Ä–∏–º–µ—Ä–Ω—ã–π –ª–∏–º–∏—Ç ~1.5MB
                                        try {
                                            let t = currentUser.imageData.startsWith('/9j/') ? 'image/jpeg' : 'image/png';
                                            avatarSrc = `data:${t};base64,${currentUser.imageData}`;
                                        } catch(e) {
                                            console.error("Error creating avatar data URI in header:", e);
                                            // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
                                        }
                                    } else {
                                        console.warn("Header avatar skipped: Image data too large.");
                                    }
                                }
                            %>
                            <img src="<%= avatarSrc %>" alt="Avatar" class="user-avatar" id="headerUserAvatar">
                        </div>
                    </a>
                    <form action="/logout" method="POST" class="logout-form">
                         <button type="submit" class="btn btn-logout" title="–í—ã–π—Ç–∏">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2h-5v-2h5V7l5 5-5 5zM14 20H6c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2h8v2H6v12h8v2z"></path></svg>
                         </button>
                     </form>
                </div>
            <% } %>
        </div>
        <%# –ö–Ω–æ–ø–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é (—Å—Ç–∏–ª—è–º–∏ —Å–∫—Ä—ã—Ç–∞/–ø–æ–∫–∞–∑–∞–Ω–∞) %>
        <button class="mobile-nav-toggle" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é" style="display: none;">‚ò∞</button>
    </nav>
</header>

<%# --- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ª–æ–≥–∏–∫–∞ Socket.IO –∫–ª–∏–µ–Ω—Ç–∞ --- %>
<% if (currentUser) { %>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // *** –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–ö–ê–ó–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –° –ó–í–£–ö–û–ú ***
        function showJsNotification(type, text, duration = 7000, playSound = true) {
            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
            const container = document.getElementById('js-messages-rentals') // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞—Ä–µ–Ω–¥
                         || document.getElementById('js-messages-container') // –ü–æ—Ç–æ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±—Ä–æ–Ω–µ–π
                         || document.getElementById('js-review-messages') // –ü–æ—Ç–æ–º –Ω–∞ –¥–µ—Ç–∞–ª—è—Ö –æ–±—ä–µ–∫—Ç–∞
                         || document.getElementById('js-messages-user-list') // –ü–æ—Ç–æ–º –≤ —Å–ø–∏—Å–∫–µ —é–∑–µ—Ä–æ–≤
                         || document.getElementById('js-messages-user-form') // –ü–æ—Ç–æ–º –≤ —Ñ–æ—Ä–º–µ —é–∑–µ—Ä–∞
                         || document.getElementById('js-messages')          // –ü–æ—Ç–æ–º –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö (–ø—Ä–æ—Ñ–∏–ª—å, –¥–∞—à–±–æ—Ä–¥...)
                         || document.getElementById('js-company-messages') // –ü–æ—Ç–æ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ–º–ø–∞–Ω–∏–∏
                         || document.body.querySelector('main.container') // –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ - –≤ main
                         || document.body; // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤ body

            if (!container) {
                console.warn("No suitable container found for JS notification.");
                return; // –ù–µ –º–æ–∂–µ–º –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            }

            // --- –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –ó–í–£–ö–ê ---
            if (playSound) {
                try {
                    // –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É –∑–≤—É–∫–æ–≤–æ–º—É —Ñ–∞–π–ª—É –≤ /public
                    const audio = new Audio('/sounds/notification.mp3');
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏, –ª–æ–≤–∏–º –≤–æ–∑–º–æ–∂–Ω—É—é –æ—à–∏–±–∫—É (–±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–ø–ª–µ–π)
                    audio.play().catch(e => console.warn("Audio playback failed (browser might block autoplay without user interaction):", e));
                } catch (e) {
                    console.error("Error creating or playing notification sound:", e);
                }
            }
            // --- –ö–û–ù–ï–¶ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø –ó–í–£–ö–ê ---

            const notifDiv = document.createElement('div');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ flash-—Å–æ–æ–±—â–µ–Ω–∏–π
            notifDiv.className = `flash-message flash-${type}`;
            // –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –±–∞–∑–æ–≤–æ–≥–æ –≤–∏–¥–∞
            notifDiv.style.cssText = 'opacity:0; transform:translateY(-10px); transition: opacity 0.5s ease, transform 0.5s ease; margin-top: 10px; cursor: pointer; z-index: 1056; position: relative;'; // –î–æ–±–∞–≤–∏–ª z-index –∏ position relative
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å HTML (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Å—ã–ª–∫—É)
            notifDiv.innerHTML = `${text} <button type="button" class="close-flash" onclick="event.stopPropagation(); this.parentElement.remove()">√ó</button>`;

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Å–∞–º–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            notifDiv.addEventListener('click', () => notifDiv.remove());

            // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            if (container.firstChild) {
                container.insertBefore(notifDiv, container.firstChild);
            } else {
                container.appendChild(notifDiv);
            }

            // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ (–Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞)
            setTimeout(() => {
                notifDiv.style.opacity = '1';
                notifDiv.style.transform = 'translateY(0)';
            }, 10);

            // –ü–ª–∞–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 'duration' –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                 notifDiv.style.opacity = '0';
                 notifDiv.style.transform = 'translateY(-10px)';
                 // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                 setTimeout(() => notifDiv.remove(), 500);
             }, duration);
        }


        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('[Socket.IO Client] Initializing...');
                const socket = io({
                    reconnectionAttempts: 5,
                    reconnectionDelay: 3000,
                     // –î–æ–±–∞–≤–∏–º query –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ—Å—Å–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–æ–±—ã—á–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å io.use)
                     // query: { sessionId: document.cookie.match(/connect.sid=s%3A([^;]+)/)?.[1] }
                 });
                let currentUsername = null;
                try {
                    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—ã–≤–æ–¥ EJS –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                    currentUsername = decodeURIComponent("<%= encodeURIComponent(currentUser.username) %>");
                } catch(e) {
                    console.error("Could not get username from EJS:", e);
                }

                if (!currentUsername) {
                    console.error("[Socket.IO Client] Username missing. Socket features disabled.");
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç username
                }

                socket.on('connect', () => {
                    console.log(`[Socket.IO Client] Connected with id: ${socket.id}. Registering user: ${currentUsername}`);
                    socket.emit('register_user', currentUsername); // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                });

                socket.on('disconnect', (reason) => {
                    console.warn(`[Socket.IO Client] Disconnected from server. Reason: ${reason}`);
                });

                socket.on('connect_error', (err) => {
                    console.error(`[Socket.IO Client] Connection Error: ${err.message}`);
                    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                    // showJsNotification('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.', 10000, false);
                });

                // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ ---

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è Tenant)
                socket.on('balance_updated', (newBalance) => {
                    const userRoleElement = document.getElementById('headerUserRole');
                    const isTenant = userRoleElement && userRoleElement.textContent === 'Tenant';
                    if (isTenant) {
                        console.log(`[Socket.IO Client] Event 'balance_updated' received: ${newBalance}`);
                        const balanceEl = document.getElementById('headerUserBalance');
                        if (balanceEl && typeof newBalance === 'number') {
                             try {
                                 balanceEl.textContent = new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(newBalance);
                             } catch (e) {
                                 console.error("Error formatting balance:", e);
                                 balanceEl.textContent = "ERR";
                             }
                        }
                    } else {
                        console.log("[Socket.IO Client] Ignored 'balance_updated' event for non-tenant user.");
                    }
                });

                 // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
                socket.on('avatar_updated', () => {
                     console.log(`[Socket.IO Client] Event 'avatar_updated' received for ${currentUsername}.`);
                     const avatarImg = document.getElementById('headerUserAvatar');
                     if (avatarImg) {
                         // –ü—Ä–æ—Å—Ç–µ–π—à–∏–π —Å–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–∏—Ç—å - –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –∫ URL, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞
                         // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è data URI, –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ AJAX
                         if (avatarImg.src.startsWith('data:')) {
                             console.log("Avatar is data URI, reload page or implement AJAX update for avatar.");
                             // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                             showJsNotification('info', '–í–∞—à –∞–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.', 5000, false);
                         } else {
                             avatarImg.src = avatarImg.src.split('?')[0] + '?t=' + new Date().getTime(); // –î–æ–±–∞–≤–ª—è–µ–º timestamp
                         }
                     }
                     // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–æ—Ñ–∏–ª—è, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                     const profileAvatar = document.querySelector('.profile-avatar'); // –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ profile.ejs
                     if (profileAvatar && profileAvatar.src !== avatarImg?.src) {
                         if (profileAvatar.src.startsWith('data:')) {
                             // –û–ø—è—Ç—å –∂–µ, –Ω—É–∂–µ–Ω AJAX –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                         } else {
                              profileAvatar.src = profileAvatar.src.split('?')[0] + '?t=' + new Date().getTime();
                         }
                     }
                });

                 // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è (–∏–º—è/—Ä–æ–ª—å/–∫–æ–º–ø–∞–Ω–∏—è)
                 socket.on('profile_data_updated', (data) => {
                     console.log(`[Socket.IO Client] Event 'profile_data_updated' received:`, data);
                     const nameEl = document.getElementById('headerUserName');
                     const roleEl = document.getElementById('headerUserRole');
                     const companyContainer = document.querySelector('.user-sub-info .user-company'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä span.user-company
                     const companyTextSpan = companyContainer?.querySelector('span'); // –¢–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ span.user-company

                     if (nameEl && data?.fullName) { nameEl.textContent = data.fullName; }
                     if (roleEl && data?.role) { roleEl.textContent = data.role; }

                      // –û–±–Ω–æ–≤–ª—è–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º/—É–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ –æ –∫–æ–º–ø–∞–Ω–∏–∏
                      if (companyContainer) { // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞–∑–º–µ—Ç–∫–µ
                          if (data?.companyName && (data.role === 'Owner' || data.role === 'Staff')) {
                               if (companyTextSpan) companyTextSpan.textContent = data.companyName; // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                               companyContainer.title = data.companyName; // –û–±–Ω–æ–≤–ª—è–µ–º title
                               companyContainer.style.display = 'inline-flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –±—ã–ª —Å–∫—Ä—ã—Ç
                          } else {
                               companyContainer.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π –∏–ª–∏ –µ—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏
                          }
                      } else if (data?.companyName && (data.role === 'Owner' || data.role === 'Staff')) {
                           // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –ù–ï –±—ã–ª–æ, –∞ —Ç–µ–ø–µ—Ä—å –æ–Ω –Ω—É–∂–µ–Ω - —Å–ª–æ–∂–Ω–µ–µ.
                           // –ü—Ä–æ—â–µ –ø–æ–ª–æ–∂–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–æ–ª–∏ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏.
                            console.warn("Header company element not found, cannot display company name dynamically.");
                      }

                      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—Å—ã–ª–æ–∫ –≤ –º–µ–Ω—é (–ø—Ä–∏–º–µ—Ä –¥–ª—è "–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç")
                      const addPropertyLink = document.querySelector('.main-nav-links a[href="/properties/add"]');
                      if (addPropertyLink) {
                            const canAdd = data?.role === 'Admin' || (data?.role === 'Owner' && data?.companyProfileCompleted === true);
                            addPropertyLink.style.display = canAdd ? 'inline' : 'none';
                      }
                      // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–µ —Å—Å—ã–ª–∫–∏ ('–ú–æ—è –ö–æ–º–ø–∞–Ω–∏—è', '–£–ø—Ä. –ê—Ä–µ–Ω–¥–∞–º–∏' –∏ —Ç.–¥.)
                 });

                 // –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
                 socket.on('account_deleted', (data) => {
                     console.warn(`[Socket.IO Client] Event 'account_deleted' received:`, data?.message);
                     if(socket.connected) {
                        socket.disconnect(); // –û—Ç–∫–ª—é—á–∞–µ–º —Å–æ–∫–µ—Ç
                     }
                     // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º
                     alert(data?.message || '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.');
                     // –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –¥–ª—è /logout
                     const logoutForm = document.createElement('form');
                     logoutForm.method = 'POST';
                     logoutForm.action = '/logout';
                     document.body.appendChild(logoutForm);
                     logoutForm.submit();
                 });

                // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –ë–†–û–ù–ò–†–û–í–ê–ù–ò–Ø–• ---

                // 1. –î–ª—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: –ë—Ä–æ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
                socket.on('booking_confirmed', (data) => {
                    console.log("[Socket.IO Client] Event 'booking_confirmed':", data);
                    showJsNotification('success', `‚úÖ –ë—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>" <strong>–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</strong>!`, 7000, true);
                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞ /bookings
                    const row = document.getElementById(`booking-row-${data.bookingId}`);
                    if (row && window.location.pathname === '/bookings') { // –¢–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±—Ä–æ–Ω–µ–π
                        const statusCell = row.querySelector('.status-cell .status-label');
                        const actionsCell = row.querySelector('.actions-cell');
                        if (statusCell) { statusCell.textContent = '–ê–∫—Ç–∏–≤–Ω–∞'; statusCell.className = 'status-label status-active'; statusCell.title = '–ê–∫—Ç–∏–≤–Ω–∞'; }
                         if (actionsCell) {
                             const form = actionsCell.querySelector('form'); if(form) form.dataset.currentStatus = '–ê–∫—Ç–∏–≤–Ω–∞'; // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è confirm()
                         }
                    }
                });

                // 2. –î–ª—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: –ë—Ä–æ–Ω—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞
                socket.on('booking_rejected', (data) => {
                    console.log("[Socket.IO Client] Event 'booking_rejected':", data);
                    const reasonText = data.reason ? ` –ü—Ä–∏—á–∏–Ω–∞: ${data.reason}` : '';
                    showJsNotification('warning', `‚ùå –ó–∞–ø—Ä–æ—Å #${data.bookingId?.substring(0,6)} –Ω–∞ "<strong>${data.propertyTitle || '?'}</strong>" <strong>–æ—Ç–∫–ª–æ–Ω–µ–Ω</strong>.${reasonText}`, 10000, true);
                    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞ /bookings
                     const row = document.getElementById(`booking-row-${data.bookingId}`);
                     if (row && window.location.pathname === '/bookings') {
                        const statusCell = row.querySelector('.status-cell'); // –í—Å—è —è—á–µ–π–∫–∞
                        const actionsCell = row.querySelector('.actions-cell');
                         if (statusCell) {
                             statusCell.innerHTML = `<span class="status-label status-rejected" title="–û—Ç–∫–ª–æ–Ω–µ–Ω–∞">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</span>`;
                             if(data.reason) { statusCell.innerHTML += ` <i class="fas fa-info-circle" title="${data.reason}" style="margin-left: 5px; color: #d35400; cursor: help;"></i>`; }
                         }
                         if (actionsCell) { actionsCell.innerHTML = '<span>-</span>'; } // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É –û—Ç–º–µ–Ω–∏—Ç—å
                     }
                });

                // 3. –î–ª—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: –ë—Ä–æ–Ω—å –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º/–∞–¥–º–∏–Ω–æ–º
                socket.on('booking_cancelled_by_owner', (data) => {
                    console.log("[Socket.IO Client] Event 'booking_cancelled_by_owner':", data);
                    showJsNotification('error', `‚ùó –ë—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>" –±—ã–ª–∞ <strong>–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞</strong> –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.`, 10000, true);
                     // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –Ω–∞ /bookings
                    const row = document.getElementById(`booking-row-${data.bookingId}`);
                    if (row && window.location.pathname === '/bookings') {
                        const statusCell = row.querySelector('.status-cell .status-label');
                        const actionsCell = row.querySelector('.actions-cell');
                         if (statusCell) { statusCell.textContent = '–ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞'; statusCell.className = 'status-label status-annulled'; statusCell.title = '–ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞'; }
                         if (actionsCell) { actionsCell.innerHTML = '<span>-</span>'; }
                    }
                });

                // 4. –î–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞/Staff: –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                socket.on('new_booking_pending', (data) => {
                    console.log("[Socket.IO Client] Event 'new_booking_pending':", data);
                    if (!window.location.pathname.startsWith('/rentals')) {
                        showJsNotification('info', `üì¨ –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>" –æ—Ç ${data.tenantName}. <a href="/rentals" style='color:inherit; font-weight:bold;'>–ö –∞—Ä–µ–Ω–¥–∞–º</a>`, 15000, true);
                    }
                    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É "–û–∂–∏–¥–∞—é—Ç" –Ω–∞ /rentals
                    // (–≠—Ç–æ —Å–ª–æ–∂–Ω–µ–µ, —Ç.–∫. —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ HTML –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
                });

                // 5. –î–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞/Staff: –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω–∏–ª –û–ñ–ò–î–ê–Æ–©–£–Æ –±—Ä–æ–Ω—å
                socket.on('pending_booking_cancelled', (data) => {
                     console.log("[Socket.IO Client] Event 'pending_booking_cancelled':", data);
                     showJsNotification('warning', `‚ùå –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä <strong>${data.tenantName}</strong> –æ—Ç–º–µ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å #${data.bookingId?.substring(0,6)} –Ω–∞ "<strong>${data.propertyTitle || '?'}</strong>".`, 7000, true);
                     // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã "–û–∂–∏–¥–∞—é—Ç" –Ω–∞ /rentals
                      const row = document.getElementById(`rental-row-${data.bookingId}`);
                      if (row && window.location.pathname.startsWith('/rentals')) {
                          row.remove();
                          // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
                          const pendingCountSpan = document.getElementById('pendingCount');
                          if(pendingCountSpan) {
                               let count = parseInt(pendingCountSpan.textContent || '0') - 1;
                               pendingCountSpan.textContent = Math.max(0, count); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–µ < 0
                          }
                          // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –±—Ä–æ–Ω–µ–π", –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π
                            const pendingBody = document.getElementById('pendingBookingsTableBody');
                            const noPendingMsg = pendingBody?.closest('.rentals-section')?.querySelector('.no-bookings-message');
                            if(pendingBody && noPendingMsg) {
                                noPendingMsg.style.display = pendingBody.rows.length === 0 ? 'block' : 'none';
                            }
                      }
                 });

                 // 6. –î–ª—è –í–ª–∞–¥–µ–ª—å—Ü–∞/Staff: –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω–∏–ª –ê–ö–¢–ò–í–ù–£–Æ –±—Ä–æ–Ω—å
                 socket.on('active_booking_cancelled', (data) => {
                     console.log("[Socket.IO Client] Event 'active_booking_cancelled':", data);
                     showJsNotification('error', `üö´ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä <strong>${data.tenantName}</strong> –æ—Ç–º–µ–Ω–∏–ª –∞–∫—Ç–∏–≤–Ω—É—é –±—Ä–æ–Ω—å #${data.bookingId?.substring(0,6)} –¥–ª—è "<strong>${data.propertyTitle || '?'}</strong>".`, 10000, true);
                     // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Ç–∞–±–ª–∏—Ü–µ "–ê–∫—Ç–∏–≤–Ω—ã–µ/–ü—Ä–æ—à–µ–¥—à–∏–µ" –Ω–∞ /rentals
                     const row = document.getElementById(`rental-row-${data.bookingId}`);
                     if (row && window.location.pathname.startsWith('/rentals')) {
                         const statusCell = row.querySelector('.status-cell .status-label');
                         const actionsCell = row.querySelector('.actions-cell');
                         if (statusCell) { statusCell.textContent = '–û—Ç–º–µ–Ω–µ–Ω–∞'; statusCell.className = 'status-label status-cancelled'; statusCell.title = '–û—Ç–º–µ–Ω–µ–Ω–∞'; }
                         row.dataset.status = '–û—Ç–º–µ–Ω–µ–Ω–∞';
                         if (actionsCell) {
                             actionsCell.innerHTML = ''; // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É "–ê–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å"
                             const isAdmin = document.body.querySelector('#pendingBookingsTableBody')?.closest('table')?.parentElement?.dataset?.isAdmin === 'true';
                             if (isAdmin) {
                                  actionsCell.innerHTML = `
                                       <form class="rental-action-form" data-action="delete" data-booking-id="${data.bookingId}" action="/rentals/${data.bookingId}/delete" method="POST">
                                           <button type="submit" class="btn btn-small btn-delete"> <span class="button-text">–£–¥–∞–ª–∏—Ç—å</span> <i class="fas fa-spinner fa-spin button-spinner"></i> </button>
                                       </form>`;
                             } else { actionsCell.innerHTML = '<span>-</span>'; }
                         }
                     }
                 });


            } catch(e) {
                console.error("[Socket.IO Client] Error setting up listeners:", e);
            }
        });
    </script>
<% } %>